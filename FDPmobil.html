<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Tjänstgöring (D-1, D, D+1)</title>

  <!-- Gör appen mobilvänlig -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tjänstgöring">
  <link rel="apple-touch-icon" href="ikon.png">

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
      overscroll-behavior: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
    }
    canvas {
      border: 1px solid #444;
      background: #222;
      margin: 10px auto;
      display: block;
      cursor: pointer;
      width: 100%;
      height: auto;
      aspect-ratio: 2.7;
      touch-action: manipulation;
    }
    input, button {
      font-size: 1em;
      margin: 0 5px;
      padding: 5px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Tjänstgöring (D-1, D, D+1)</h1>

<div>
  Starttid: <input type="datetime-local" id="start" />
  Sluttid: <input type="datetime-local" id="slut" />
  <button onclick="läggTillEllerUppdateraPass()">Lägg till / Uppdatera pass</button>
  <button onclick="rensaInmatning()">Rensa</button>
</div>

<canvas id="canvas"></canvas>

<div id="status"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let arbetspass = [];
let redigerarIndex = -1;
let passPositions = [];

function justeraCanvasStorlek() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
window.addEventListener("resize", () => {
  justeraCanvasStorlek();
  uppdatera();
});
justeraCanvasStorlek();

function läggTillEllerUppdateraPass() {
  const s = document.getElementById("start").value;
  const e = document.getElementById("slut").value;
  if (!s || !e) {
    alert("Fyll i både start och sluttid");
    return;
  }
  const start = new Date(s);
  const slut = new Date(e);
  if (slut <= start) {
    alert("Sluttid måste vara efter starttid");
    return;
  }

  if (redigerarIndex >= 0) {
    arbetspass[redigerarIndex] = { start, slut };
    redigerarIndex = -1;
  } else {
    arbetspass.push({ start, slut });
  }
  rensaInmatning();
  uppdatera();
}

function rensaInmatning() {
  document.getElementById("start").value = "";
  document.getElementById("slut").value = "";
  redigerarIndex = -1;
}

function nollställTid(date) {
  return new Date(date.getFullYear(), date.getMonth(), date.getDate());
}

function rita() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const now = new Date();
  const d0 = nollställTid(now);
  const d24 = new Date(d0.getTime() - 24 * 3600 * 1000);
  const pxPerMs = canvas.width / (24 * 3600 * 1000);
  passPositions = [];

  const linjaler = [
    { label: "D-1 (gårdagen)", start: d24, y: canvas.height * 0.2 },
    { label: "D (idag)", start: d0, y: canvas.height * 0.5 },
    { label: "D+1 (imorgon)", start: new Date(d0.getTime() + 24 * 3600 * 1000), y: canvas.height * 0.8 },
  ];

  ctx.font = "12px monospace";
  ctx.textBaseline = "middle";

  linjaler.forEach(({ label, start, y }) => {
    ctx.fillStyle = "#333";
    ctx.fillRect(0, y - 20, canvas.width, 40);

    ctx.strokeStyle = "#666";
    ctx.fillStyle = "#aaa";
    for (let h = 0; h <= 24; h++) {
      const x = (h / 24) * canvas.width;
      ctx.beginPath();
      ctx.moveTo(x, y - 20);
      ctx.lineTo(x, y + 20);
      ctx.stroke();
      ctx.fillText(h.toString().padStart(2, "0") + ":00", x + 2, y - 10);
    }

    ctx.fillStyle = "#fff";
    ctx.fillText(label, 5, y - 30);
  });

  const sorter = [...arbetspass].sort((a, b) => a.start - b.start);
  const d24Time = now.getTime() - 24 * 3600 * 1000;

  sorter.forEach((p, i) => {
    linjaler.forEach(({ start, y }) => {
      const linStartMs = start.getTime();
      const linEndMs = linStartMs + 24 * 3600 * 1000;
      const passStart = p.start.getTime();
      const passEnd = p.slut.getTime();

      const segmenter = [];

      if (passStart < d24Time && passEnd > d24Time) {
        segmenter.push({ from: passStart, to: d24Time, färg: "#666" });
        segmenter.push({ from: d24Time, to: passEnd, färg: "#0f0" });
      } else {
        const färg = passEnd <= d24Time ? "#666" : "#0f0";
        segmenter.push({ from: passStart, to: passEnd, färg });
      }

      segmenter.forEach(seg => {
        const ritaStart = Math.max(seg.from, linStartMs);
        const ritaEnd = Math.min(seg.to, linEndMs);
        if (ritaEnd <= ritaStart) return;
        const x = (ritaStart - linStartMs) * pxPerMs;
        const w = (ritaEnd - ritaStart) * pxPerMs;
        ctx.fillStyle = seg.färg;
        ctx.fillRect(x, y - 10, w, 20);
        if (seg.färg === "#0f0") {
          passPositions.push({ index: i, xStart: x, yStart: y - 10, bredd: w, höjd: 20 });
        }
      });
    });
  });

  const vilor = [];
  for (let i = 0; i < sorter.length - 1; i++) {
    const end = sorter[i].slut.getTime();
    const nextStart = sorter[i + 1].start.getTime();
    if (nextStart > end) {
      vilor.push({ start: new Date(end), slut: new Date(nextStart) });
    }
  }
  if (sorter.length > 0 && now > sorter[sorter.length - 1].slut) {
    vilor.push({ start: sorter[sorter.length - 1].slut, slut: now });
  }

  vilor.forEach(v => {
    const vilaTid = v.slut - v.start;
    const färg = vilaTid >= 4 * 3600 * 1000 ? "#00f" : (vilaTid < 2 * 3600 * 1000 ? "#0f0" : "#88f");
    const höjd = vilaTid < 2 * 3600 * 1000 ? 4 : 10;

    linjaler.forEach(({ start, y }) => {
      const linStart = start.getTime();
      const linEnd = linStart + 24 * 3600 * 1000;
      const ritaStart = Math.max(v.start.getTime(), linStart);
      const ritaEnd = Math.min(v.slut.getTime(), linEnd);
      if (ritaEnd <= ritaStart) return;
      const x = (ritaStart - linStart) * pxPerMs;
      const w = (ritaEnd - ritaStart) * pxPerMs;
      ctx.fillStyle = färg;
      ctx.fillRect(x, y - höjd / 2, w, höjd);
    });
  });

  const xNow = (now.getTime() - d0.getTime()) * pxPerMs;
  ctx.strokeStyle = "red";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(xNow, linjaler[0].y + 20);
  ctx.lineTo(xNow, linjaler[2].y - 20);
  ctx.stroke();

  linjaler.forEach(({ start, y }) => {
    const linStart = start.getTime();
    const linEnd = linStart + 24 * 3600 * 1000;
    if (d24Time >= linStart && d24Time <= linEnd) {
      const xD24 = (d24Time - linStart) * pxPerMs;
      ctx.strokeStyle = "red";
      ctx.beginPath();
      ctx.moveTo(xD24, y - 20);
      ctx.lineTo(xD24, y + 20);
      ctx.stroke();
    }
  });

  const nu = now.getTime();
  let totalArbetstid = 0;
  let totalVilotid = 0;

  sorter.forEach(p => {
    const s = Math.max(p.start.getTime(), d24Time);
    const e = Math.min(p.slut.getTime(), nu);
    if (e > s) totalArbetstid += e - s;
  });

  vilor.forEach(v => {
    const s = Math.max(v.start.getTime(), d24Time);
    const e = Math.min(v.slut.getTime(), nu);
    const tid = e - s;
    if (tid > 0) {
      if (tid < 2 * 3600 * 1000) {
        totalArbetstid += tid;
      } else {
        totalVilotid += tid;
      }
    }
  });

  function format(ms) {
    const h = Math.floor(ms / 3600000);
    const m = Math.round((ms % 3600000) / 60000);
    return `${h}h ${m}min`;
  }

  document.getElementById("status").textContent =
    `Antal pass: ${arbetspass.length} | Arbetstid (D-24 → nu): ${format(totalArbetstid)} | Vilotid: ${format(totalVilotid)}`;
}

function uppdatera() {
  justeraCanvasStorlek();
  rita();
}
setInterval(uppdatera, 60000);
uppdatera();

canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const träff = passPositions.find(p =>
    x >= p.xStart && x <= p.xStart + p.bredd &&
    y >= p.yStart && y <= p.yStart + p.höjd
  );
  if (träff) {
    const p = arbetspass[träff.index];
    const tzOffset = new Date().getTimezoneOffset() * 60000;
    document.getElementById("start").value = new Date(p.start - tzOffset).toISOString().slice(0, 16);
    document.getElementById("slut").value = new Date(p.slut - tzOffset).toISOString().slice(0, 16);
    redigerarIndex = träff.index;
  }
});

canvas.addEventListener("dblclick", e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const träff = passPositions.find(p =>
    x >= p.xStart && x <= p.xStart + p.bredd &&
    y >= p.yStart && y <= p.yStart + p.höjd
  );
  if (träff) {
    arbetspass.splice(träff.index, 1);
    uppdatera();
  }
});
</script>

</body>
</html>

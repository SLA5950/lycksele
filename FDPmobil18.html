<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FDP</title>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: sans-serif;
            text-align: center;
            margin: 10px;
            padding: 10px;
        }
        canvas {
            width: 100%;
            max-width: 1000px;
            height: auto;
            border: 1px solid #444;
            background: #222;
            margin: 10px auto;
            display: block;
            cursor: pointer;
        }
        input, button {
            font-size: 1em;
            margin: 5px;
            padding: 6px 8px;
            max-width: 90vw;
        }
        #status {
            margin-top: 10px;
            font-weight: bold;
        }
        button.knapp-grön {
            background-color: #0a0 !important;
            color: #fff !important;
            border: none;
        }
        button.knapp-röd {
            background-color: #a00 !important;
            color: #fff !important;
            border: none;
        }
    </style>
</head>
<body>

<div>
    <div style="white-space: nowrap; display: inline-block; margin-right: 1em;">
        Starttid: <input type="datetime-local" id="start" />
    </div>
    <div style="white-space: nowrap; display: inline-block; margin-right: 1em;">
        Sluttid: <input type="datetime-local" id="slut" />
    </div>
    <button onclick="läggTillEllerUppdateraPass()">Add/Uppdatera</button>
    <button id="btnTaBort" onclick="taBortPass()" disabled>Delete pass</button>
    <button id="btnStartStop" onclick="startaEllerStoppaPass()">Starta pass</button>
    <button id="btnStartStopSet" onclick="startaEllerStoppaMedSet()">Start SET</button>
    <button id="resetStorageBtn">Nollställ</button>
</div>

<canvas id="canvas"></canvas>

<div id="status"></div>
<div id="fdpResult" style="margin-top: 8px; font-weight: bold; color: orange;"></div>

<div id="legend" style="margin-top: 10px; text-align: left; max-width: 1000px; margin-left: auto; margin-right: auto;">
    <div style="display: flex; align-items: center; margin: 4px 0;">
        <div style="width: 40px; height: 10px; background: #0f0; margin-right: 8px;"></div>
        <span>Arbetstid</span>
    </div>
    <div style="display: flex; align-items: center; margin: 4px 0;">
        <div style="width: 40px; height: 4px; background: #0f0; margin-right: 8px;"></div>
        <span>&lt; 2h mellan arbetspass</span>
    </div>
    <div style="display: flex; align-items: center; margin: 4px 0;">
        <div style="width: 40px; height: 6px; background: #88f; margin-right: 8px;"></div>
        <span>Vila ≥ 2h och &lt; 4h</span>
    </div>
    <div style="display: flex; align-items: center; margin: 4px 0;">
        <div style="width: 40px; height: 10px; background: #00f; margin-right: 8px;"></div>
        <span>Vila ≥ 4h och &lt; 8h</span>
    </div>
    <div style="display: flex; align-items: center; margin: 4px 0;">
        <div style="width: 40px; height: 10px; background: yellow; margin-right: 8px;"></div>
        <span>Vila ≥ 8h</span>
    </div>
    <div style="display: flex; align-items: center; margin: 20px 0; color: #606060;">
        Copyright Ove Lundström &copy;
    </div>
</div>
<script>
    document.getElementById('resetStorageBtn').addEventListener('click', () => {
        localStorage.clear();
        alert('Minne har nollställts! Ladda om sidan!');
        location.reload();
    });

    function genereraId() {
        return '_' + Math.random().toString(36).substr(2, 9);
    }

    function localDatetimeString(date) {
        const pad = n => n.toString().padStart(2, '0');
        return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) +
            'T' + pad(date.getHours()) + ':' + pad(date.getMinutes());
    }

    function parseLocalDatetime(s) {
        if (!s) return null;
        const [datePart, timePart] = s.split('T');
        const [year, month, day] = datePart.split('-').map(Number);
        const [hour, minute] = timePart.split(':').map(Number);
        return new Date(year, month - 1, day, hour, minute);
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let arbetspass = [];
    let redigerarIndex = -1;
    let passPositions = [];
    let markeratPassId = null;
    let pågåendePass = null;
    let blinkState = true; 

    const btnStartStop = document.getElementById("btnStartStop");
    const btnStartStopSet = document.getElementById("btnStartStopSet");

    function uppdateraKnappar() {
        if (pågåendePass) {
            btnStartStop.textContent = "Stoppa pass";
            btnStartStop.classList.remove("knapp-röd");
            btnStartStop.classList.add("knapp-grön");
            btnStartStopSet.textContent = "S+30";
            btnStartStopSet.classList.remove("knapp-röd");
            btnStartStopSet.classList.add("knapp-grön");
        } else {
            btnStartStop.textContent = "Starta pass";
            btnStartStop.classList.remove("knapp-grön");
            btnStartStop.classList.add("knapp-röd");
            btnStartStopSet.textContent = "Start SET";
            btnStartStopSet.classList.remove("knapp-grön");
            btnStartStopSet.classList.add("knapp-röd");
        }
    }

    function laddaFrånMinne() {
        const sparade = localStorage.getItem("arbetspass");
        if (sparade) {
            try {
                arbetspass = JSON.parse(sparade).map(p => ({
                    id: p.id || genereraId(),
                    start: new Date(p.start),
                    slut: new Date(p.slut)
                }));
            } catch (e) {
                console.warn("Fel vid inläsning av arbetspass från localStorage", e);
            }
        }
        // Kontrollera om arbetspass-arrayen är tom och lägg till ett standardpass om så är fallet.
        if (arbetspass.length === 0) {
            arbetspass.push({
                id: genereraId(),
                start: new Date('2022-01-01T02:00:00'),
                slut: new Date('2022-01-01T03:00:00')
            });
        }

        const pågåendeSparat = localStorage.getItem("pågåendePass");
        if (pågåendeSparat) {
            try {
                const obj = JSON.parse(pågåendeSparat);
                if (obj && obj.start) {
                    pågåendePass = { id: obj.id, start: new Date(obj.start) };
                }
            } catch (e) {
                console.warn("Fel vid inläsning av pågående pass från localStorage", e);
            }
        }
        uppdateraKnappar();
    }


    laddaFrånMinne();

    function läggTillEllerUppdateraPass() {
        const s = document.getElementById("start").value;
        const e = document.getElementById("slut").value;
        if (!s || !e) {
            alert("Fyll i både start och sluttid");
            return;
        }
        const start = parseLocalDatetime(s);
        const slut = parseLocalDatetime(e);
        if (slut <= start) {
            alert("Sluttid måste vara efter starttid");
            return;
        }

        if (redigerarIndex >= 0) {
            arbetspass[redigerarIndex].start = start;
            arbetspass[redigerarIndex].slut = slut;
        } else {
            arbetspass.push({ id: genereraId(), start, slut });
        }

        localStorage.setItem("arbetspass", JSON.stringify(arbetspass));
        rensaInmatning();
        markeratPassId = null;
        document.getElementById("btnTaBort").disabled = true;
        rita();
        uppdatera();
    }

    function rensaInmatning() {
        document.getElementById("start").value = "";
        document.getElementById("slut").value = "";
        redigerarIndex = -1;
        markeratPassId = null;
        document.getElementById("btnTaBort").disabled = true;
    }

    function taBortPass() {
        if (markeratPassId) {
            arbetspass = arbetspass.filter(p => p.id !== markeratPassId);
            if (pågåendePass && pågåendePass.id === markeratPassId) {
                localStorage.removeItem("pågåendePass");
                pågåendePass = null;
            } else {
                localStorage.setItem("arbetspass", JSON.stringify(arbetspass));
            }
            rensaInmatning();
            uppdatera();
        }
    }

    function nollställTid(date) {
        return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function formatDatum(date) {
        const m = (date.getMonth() + 1).toString().padStart(2, "0");
        const d = date.getDate().toString().padStart(2, "0");
        return m + d;
    }

    function storleksanpassaCanvas() {
        const bredd = canvas.clientWidth;
        const höjd = 220;
        canvas.width = bredd;
        canvas.height = höjd;
    }

    function startaEllerStoppaPass() {
        const nu = new Date();
        if (pågåendePass === null) {
            pågåendePass = { id: genereraId(), start: nu };
            localStorage.setItem("pågåendePass", JSON.stringify(pågåendePass));
        } else {
            pågåendePass.slut = nu;
            arbetspass.push(pågåendePass);
            localStorage.setItem("arbetspass", JSON.stringify(arbetspass));
            localStorage.removeItem("pågåendePass");
            pågåendePass = null;
        }
        uppdateraKnappar();
        uppdatera();
    }

    function startaEllerStoppaMedSet() {
    if (pågåendePass === null) {
        const starttidStr = document.getElementById("start").value;
        const starttid = parseLocalDatetime(starttidStr);
        if (starttid && !isNaN(starttid.getTime())) {
            pågåendePass = { id: genereraId(), start: starttid };
            localStorage.setItem("pågåendePass", JSON.stringify(pågåendePass));
            uppdateraKnappar();
            uppdatera();
        } else {
            alert("Ogiltig starttid angiven. Vänligen fyll i en starttid i fältet.");
        }
    } else {
        const slut = new Date(new Date().getTime() + 30 * 60000);
        pågåendePass.slut = slut;
        arbetspass.push(pågåendePass);
        localStorage.setItem("arbetspass", JSON.stringify(arbetspass));
        localStorage.removeItem("pågåendePass");
        pågåendePass = null;
        uppdateraKnappar();
        uppdatera();
        }
    }
    
    function ritaPågåendePass(pxPerMs, linjaler, now) {
        if (!pågåendePass) return;
        linjaler.forEach(({ start, y }) => {
            const linStartMs = start.getTime();
            const linEndMs = linStartMs + 24 * 3600 * 1000;
            const passStart = pågåendePass.start.getTime();
            const passEnd = now.getTime();
            const segmenter = [];
            const nuMinus24 = new Date(now.getTime() - 24 * 3600 * 1000).getTime();
            if (passStart < nuMinus24 && passEnd > nuMinus24) {
                segmenter.push({ from: passStart, to: nuMinus24, färg: "#666" });
                segmenter.push({ from: nuMinus24, to: passEnd, färg: "#0f0" });
            } else {
                const färg = passEnd <= nuMinus24 ? "#666" : "#0f0";
                segmenter.push({ from: passStart, to: passEnd, färg });
            }
            segmenter.forEach(seg => {
                const ritaStart = Math.max(seg.from, linStartMs);
                const ritaEnd = Math.min(seg.to, linEndMs);
                if (ritaEnd <= ritaStart) return;
                const x = (ritaStart - linStartMs) * pxPerMs;
                const w = (ritaEnd - ritaStart) * pxPerMs;
                ctx.fillStyle = seg.färg;
                ctx.fillRect(x, y - 10, w, 20);
                if (seg.färg === "#0f0") {
                    passPositions.push({
                        id: pågåendePass.id,
                        xStart: x,
                        yStart: y - 10,
                        bredd: w,
                        höjd: 20,
                    });
                }
                if (pågåendePass.id === markeratPassId && blinkState) {
                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y - 10, w, 20);
                }
            });
        });
    }

    function slåIhopÖverlappandePass(passen) {
        if (passen.length === 0) return [];
        const sorterade = passen.slice().sort((a, b) => a.start - b.start);
        const resultat = [];
        let aktuell = { start: sorterade[0].start, slut: sorterade[0].slut };
        for (let i = 1; i < sorterade.length; i++) {
            const p = sorterade[i];
            if (p.start <= aktuell.slut) {
                aktuell.slut = new Date(Math.max(aktuell.slut.getTime(), p.slut.getTime()));
            } else {
                resultat.push(aktuell);
                aktuell = { start: p.start, slut: p.slut };
            }
        }
        resultat.push(aktuell);
        return resultat;
    }

    function rita() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const now = new Date();
    const d0 = nollställTid(now);
    const d24 = new Date(d0.getTime() - 24 * 3600 * 1000);
    const pxPerMs = canvas.clientWidth / (24 * 3600 * 1000);
    passPositions = [];
    const linjaler = [
        { label: formatDatum(d24), start: d24, y: 60 },
        { label: formatDatum(d0), start: d0, y: 160 },
    ];
    ctx.font = "15px monospace";
    ctx.textBaseline = "middle";
    linjaler.forEach(({ label, start, y }) => {
        ctx.fillStyle = "#333";
        ctx.fillRect(0, y - 20, canvas.width, 40);
        ctx.strokeStyle = "#666";
        ctx.fillStyle = "#aaa";
        for (let h = 0; h <= 24; h++) {
            const x = (h / 24) * canvas.width;
            ctx.beginPath();
            ctx.moveTo(x, y - 20);
            ctx.lineTo(x, y + 20);
            ctx.stroke();
            if (h % 2 === 0) {
                const text = h.toString().padStart(2, "0");
                const textWidth = ctx.measureText(text).width;
                ctx.fillText(text, x - textWidth / 2, y - 30);
            }
        }
        ctx.fillStyle = "#fff";
        ctx.fillText(label, 5, y - 45);
    });

    const sorter = [...arbetspass].sort((a, b) => a.start - b.start);
    if (pågåendePass) {
        sorter.push({ id: pågåendePass.id, start: pågåendePass.start, slut: now });
    }

    sorter.forEach((p) => {
        linjaler.forEach(({ start, y }) => {
            const linStartMs = start.getTime();
            const linEndMs = linStartMs + 24 * 3600 * 1000;
            const passStart = p.start.getTime();
            const passEnd = p.slut.getTime();
            const segmenter = [];
            const nuMinus24 = new Date(now.getTime() - 24 * 3600 * 1000).getTime();
            if (passStart < nuMinus24 && passEnd > nuMinus24) {
                segmenter.push({ from: passStart, to: nuMinus24, färg: "#666" });
                segmenter.push({ from: nuMinus24, to: passEnd, färg: "#0f0" });
            } else {
                const färg = passEnd <= nuMinus24 ? "#666" : "#0f0";
                segmenter.push({ from: passStart, to: passEnd, färg });
            }
            segmenter.forEach((seg) => {
                const ritaStart = Math.max(seg.from, linStartMs);
                const ritaEnd = Math.min(seg.to, linEndMs);
                if (ritaEnd <= ritaStart) return;
                const x = (ritaStart - linStartMs) * pxPerMs;
                const w = (ritaEnd - ritaStart) * pxPerMs;
                ctx.fillStyle = seg.färg;
                ctx.fillRect(x, y - 10, w, 20);
                if (seg.färg === "#0f0") {
                    passPositions.push({
                        id: p.id,
                        xStart: x,
                        yStart: y - 10,
                        bredd: w,
                        höjd: 20,
                    });
                }
                if (p.id === markeratPassId) {
                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y - 10, w, 20);
                }
            });
        });
    });

    const vilor = [];
    if (sorter.length > 0) {
        const senastSlutnaPass = sorter[sorter.length - 1];
        if (now > senastSlutnaPass.slut) {
            vilor.push({ start: senastSlutnaPass.slut, slut: now });
        }
    }
    for (let i = 0; i < sorter.length - 1; i++) {
        const end = sorter[i].slut.getTime();
        const nextStart = sorter[i + 1].start.getTime();
        if (nextStart > end) {
            vilor.push({ start: new Date(end), slut: new Date(nextStart) });
        }
    }

    vilor.forEach((v) => {
        const vilaTid = v.slut - v.start;
        let färg;
        if (vilaTid >= 8 * 3600 * 1000) {
            färg = "yellow";
        } else if (vilaTid >= 4 * 3600 * 1000) {
            färg = "#00f";
        } else if (vilaTid < 2 * 3600 * 1000) {
            färg = "#0f0";
        } else {
            färg = "#88f";
        }
        const höjd = vilaTid < 2 * 3600 * 1000 ? 4 : 10;
        linjaler.forEach(({ start, y }) => {
            const linStart = start.getTime();
            const linEnd = linStart + 24 * 3600 * 1000;
            const ritaStart = Math.max(v.start.getTime(), linStart);
            const ritaEnd = Math.min(v.slut.getTime(), linEnd);
            if (ritaEnd <= ritaStart) return;
            const x = (ritaStart - linStart) * pxPerMs;
            const w = (ritaEnd - ritaStart) * pxPerMs;
            ctx.fillStyle = färg;
            ctx.fillRect(x, y - höjd / 2, w, höjd);
        });
    });

    const xNow = (now.getTime() - d0.getTime()) * pxPerMs;
    ctx.strokeStyle = "red";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xNow, 40);
    ctx.lineTo(xNow, 220);
    ctx.stroke();

    let totalArbetstid = 0;
    let totalVilotid = 0;
    const tStart = now.getTime() - 24 * 3600 * 1000;
    let arbetstidStartTime = tStart;
    for (const vila of vilor) {
        const vilaTid = vila.slut.getTime() - vila.start.getTime();
        if (vilaTid >= 8 * 3600 * 1000 && vila.start.getTime() >= tStart) {
            arbetstidStartTime = Math.max(arbetstidStartTime, vila.slut.getTime());
        }
    }
    const passInomFönster = sorter
        .filter((p) => p.slut.getTime() > arbetstidStartTime && p.start.getTime() < now.getTime())
        .map((p) => ({
            start: new Date(Math.max(p.start.getTime(), arbetstidStartTime)),
            slut: new Date(Math.min(p.slut.getTime(), now.getTime())),
        }));
    const hopslagnaPass = slåIhopÖverlappandePass(passInomFönster);
    totalArbetstid = hopslagnaPass.reduce((summa, p) => summa + (p.slut - p.start), 0);
    for (const vila of vilor) {
        const vilaLängd = vila.slut.getTime() - vila.start.getTime();
        if (vilaLängd > 0 && vilaLängd < 2 * 3600 * 1000) {
            const start = Math.max(vila.start.getTime(), arbetstidStartTime);
            const slut = Math.min(vila.slut.getTime(), now.getTime());
            if (slut > start) {
                totalArbetstid += slut - start;
            }
        }
    }
    for (const vila of vilor) {
        const start = Math.max(vila.start.getTime(), tStart);
        const slut = Math.min(vila.slut.getTime(), now.getTime());
        const längd = slut - start;
        if (slut > start && längd >= 2 * 3600 * 1000) {
            totalVilotid += längd;
        }
    }

    function msTillText(ms) {
        const totS = Math.floor(ms / 1000);
        const h = Math.floor(totS / 3600);
        const m = Math.floor((totS % 3600) / 60);
        return (h > 0 ? h + "h " : "") + m.toString().padStart(2, "0") + "m";
    }
    document.getElementById("status").textContent =
        "Arbetstid: " + msTillText(totalArbetstid) +
        "\u00A0\u00A0\u00A0 Vilotid (24h): " + msTillText(totalVilotid);
    }

    function simuleraFDPMax() {
        const nu = new Date();
        const maxMinuter = 24 * 60;
        const sorter = [...arbetspass];
        if (pågåendePass) {
            sorter.push({ start: pågåendePass.start, slut: new Date() });
        }
        sorter.sort((a, b) => a.start - b.start);
        let vilor = [];
        for (let i = 0; i < maxMinuter; i++) {
            const slutTid = new Date(nu.getTime() + i * 60000);
            const simulerade = [...sorter];
            const simuleratPass = { start: nu, slut: slutTid };
            const överlappar = sorter.some(p => !(p.slut <= simuleratPass.start || p.start >= simuleratPass.slut));
            if (!överlappar) simulerade.push(simuleratPass);
            simulerade.sort((a, b) => a.start - b.start);
            vilor = [];
            for (let j = 0; j < simulerade.length - 1; j++) {
                const end = simulerade[j].slut.getTime();
                const nextStart = simulerade[j + 1].start.getTime();
                if (nextStart > end) {
                    vilor.push({ start: new Date(end), slut: new Date(nextStart) });
                }
            }
            if (simulerade.length > 0 && slutTid > simulerade[simulerade.length - 1].slut) {
                vilor.push({ start: simulerade[simulerade.length - 1].slut, slut: slutTid });
            }
            const fönsterStart = slutTid.getTime() - 24 * 3600 * 1000;
            let nollställEfter = fönsterStart;
            for (const vila of vilor) {
                const längd = vila.slut - vila.start;
                const vilaSlut = vila.slut.getTime();
                if (längd >= 8 * 3600 * 1000 && vilaSlut > fönsterStart) {
                    nollställEfter = Math.max(nollställEfter, vilaSlut);
                }
            }
            const arbetstidStart = Math.max(fönsterStart, nollställEfter);
            const relevantaPass = simulerade
                .filter(p => p.slut.getTime() > arbetstidStart && p.start.getTime() < slutTid.getTime())
                .map(p => ({
                    start: new Date(Math.max(p.start.getTime(), arbetstidStart)),
                    slut: new Date(Math.min(p.slut.getTime(), slutTid.getTime()))
                }));
            const hopslagna = slåIhopÖverlappandePass(relevantaPass);
            let arbetstid = hopslagna.reduce((summa, p) => summa + (p.slut.getTime() - p.start.getTime()), 0);
            for (const vila of vilor) {
                const s = vila.start.getTime();
                const e = vila.slut.getTime();
                const justeradStart = Math.max(s, nollställEfter, fönsterStart);
                const justeratSlut = Math.min(e, slutTid.getTime());
                const längd = justeratSlut - justeradStart;
                if (längd > 0 && (e - s) < 2 * 3600 * 1000 && justeradStart < justeratSlut) {
                    arbetstid += längd;
                }
            }
            let senasteSlut = null;
            let aktuellVilaStart = null;
            let hittadeVilor = [];
            for (const vila of vilor) {
                const s = Math.max(vila.start.getTime(), fönsterStart);
                const e = Math.min(vila.slut.getTime(), slutTid.getTime());
                if (e <= s) continue;
                if (senasteSlut !== null && s > senasteSlut) {
                    const längd = senasteSlut - aktuellVilaStart;
                    if (längd >= 4 * 3600 * 1000) hittadeVilor.push({ start: aktuellVilaStart, slut: senasteSlut });
                    aktuellVilaStart = s;
                } else if (senasteSlut === null) {
                    aktuellVilaStart = s;
                }
                senasteSlut = Math.max(senasteSlut || 0, e);
            }
            if (aktuellVilaStart !== null) {
                const längd = senasteSlut - aktuellVilaStart;
                if (längd >= 4 * 3600 * 1000) hittadeVilor.push({ start: aktuellVilaStart, slut: senasteSlut });
            }
            const harTillräckligVila = hittadeVilor.length > 0;
            const harNåttFDPmax = arbetstid >= 15 * 3600 * 1000;
            if (harNåttFDPmax && !harTillräckligVila) {
                skrivFDPResultat(`FDP max 15h nås efter ${formatTidText(i)} kl ${slutTid.toTimeString().slice(0, 5)}`);
                return;
            }
            if (harNåttFDPmax) {
                skrivFDPResultat(`FDP max 15h nås efter ${formatTidText(i)} kl ${slutTid.toTimeString().slice(0, 5)}`);
                return;
            }
            if (!harTillräckligVila) {
                skrivFDPResultat(`Vila <4h efter ${formatTidText(i)} kl ${slutTid.toTimeString().slice(0, 5)}`);
                return;
            }
        }

        function skrivFDPResultat(text) {
            const el = document.getElementById("fdpResult");
            el.textContent = text;
        }

        function formatTidText(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h}h ${m.toString().padStart(2, "0")}m`;
        }
    }
    
    // De flyttade funktionerna
    function uppdatera() {
        storleksanpassaCanvas();
        rita();
        simuleraFDPMax();
        blinkState = !blinkState;
        setTimeout(uppdatera, 1000);
    }
    canvas.addEventListener("click", e => {
        const rect = canvas.getBoundingClientRect();
        const klickX = e.clientX - rect.left;
        const klickY = e.clientY - rect.top;
        let hittat = false;
        for (let i = 0; i < passPositions.length; i++) {
            const p = passPositions[i];
            if (
                klickX >= p.xStart && klickX <= p.xStart + p.bredd &&
                klickY >= p.yStart && klickY <= p.yStart + p.höjd
            ) {
                markeratPassId = p.id;
                const pValt = arbetspass.find(p => p.id === markeratPassId);
                if (pValt) {
                    document.getElementById("start").value = localDatetimeString(pValt.start);
                    document.getElementById("slut").value = localDatetimeString(pValt.slut);
                    redigerarIndex = arbetspass.findIndex(p => p.id === markeratPassId);
                    document.getElementById("btnTaBort").disabled = false;
                    hittat = true;
                    break;
                }
            }
        }
        if (!hittat) {
            markeratPassId = null;
            redigerarIndex = -1;
            rensaInmatning();
            document.getElementById("btnTaBort").disabled = true;
        }
        rita();
    });

    // Anropa uppdatera() här, efter alla funktionsdefinitioner
    uppdatera();
</script>

</body>
</html>